name: $(Build.BuildId)

trigger:
  branches:
    include:
      - master
      - refs/tags/*

pr:
  branches:
    include:
      - master

stages:
  - stage: Build_platforms
    jobs:
      - template: .ci/build-platform.yml
        parameters:
          platform: Linux
          vmImage: ubuntu-16.04

      - template: .ci/build-platform.yml
        parameters:
          platform: macOS
          vmImage: macOS-latest

      - template: .ci/build-platform.yml
        parameters:
          platform: Windows
          vmImage: vs2017-win2016

  - stage: Create_release
    dependsOn: [Build_platforms]
    jobs:
    - job: Release
      displayName: Release
      pool:
        vmImage: ubuntu-16.04

      steps:
        - template: .ci/cross-release.yml

  - stage: Test_releases
    dependsOn: [Create_release]
    jobs:
    - job: TestReleaseLinux
      displayName: Test Release Linux
      pool:
        vmImage: ubuntu-16.04
      steps:
        - template: .ci/test-release.yml

    - job: TestReleasOsX
      displayName: Test Release osX
      pool:
        vmImage: macOS-latest
      steps:
        - template: .ci/test-release.yml

    - job: TestReleaseWindows
      displayName: Test Release Windows
      pool:
        vmImage: vs2017-win2016
      steps:
        - template: .ci/test-release.yml
